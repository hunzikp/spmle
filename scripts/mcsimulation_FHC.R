library(spmle)
library(spatialprobit)
library(risprobit)
library(spatialreg)
library(McSpatial)
library(car)  # Silent dependency of McSpatial

library(dplyr)
library(tidyr)
library(doParallel)

library(reticulate)
if(Sys.info()["sysname"]=="Linux") reticulate::use_virtualenv("r-reticulate")  # In Unix
if(Sys.info()["sysname"]=="Windows") reticulate::use_condaenv("r-reticulate")  # In Windows

# Constants ----------------------------------------------------------------------------------

n_cores <- 11
save_results <- FALSE
save_path <- "mcresults-ST-1050n-100r-FHC-200228.Rdata"
n_repetitions <- 1
has_temporal_lag = TRUE
has_spatial_lag = TRUE

# W Matrix -----------------------------------------------------------------------------------


W <- rbind(c(0,0,0,0,0,0,0,0.25,0.25,0,0,0,0,0,0,0,0,0,0,0,0,0.25,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.25,0,0,0,0,0,0,0,0,0,0),
           c(0,0,0,0.25,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.25,0,0,0.25,0,0,0,0,0,0,0,0,0,0,0,0,0.25,0,0,0,0,0,0,0,0),
           c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.166666666666667,0,0,0,0,0,0.166666666666667,0.166666666666667,0,0,0,0,0,0,0,0,0,0,0.166666666666667,0,0,0,0,0,0.166666666666667,0.166666666666667,0,0,0,0,0,0,0,0,0),
           c(0,0.333333333333333,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.333333333333333,0,0,0,0,0,0,0,0,0.333333333333333,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),
           c(0,0,0,0,0,0,0,0,0,0,0,0,0,0.166666666666667,0,0,0,0,0,0,0,0,0,0,0.166666666666667,0,0,0,0.166666666666667,0,0,0,0,0.166666666666667,0,0,0,0,0,0,0,0.166666666666667,0,0,0,0,0,0.166666666666667,0,0),
           c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.333333333333333,0,0,0,0,0,0,0,0,0,0,0.333333333333333,0,0,0,0,0,0,0.333333333333333,0,0,0,0,0,0,0,0,0,0,0,0,0),
           c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.333333333333333,0,0,0,0,0,0,0,0,0,0.333333333333333,0,0,0,0,0,0,0,0.333333333333333,0,0,0,0,0,0,0,0,0,0,0,0,0,0),
           c(0.333333333333333,0,0,0,0,0,0,0,0.333333333333333,0,0,0,0,0,0,0,0,0,0,0,0,0.333333333333333,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),
           c(0.2,0,0,0,0,0,0,0.2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.2,0,0,0,0,0,0,0.2,0,0.2,0,0,0,0,0,0,0,0,0,0),
           c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.166666666666667,0,0.166666666666667,0,0,0,0,0,0,0,0,0.166666666666667,0,0,0,0,0,0,0.166666666666667,0,0,0.166666666666667,0,0,0.166666666666667,0,0),
           c(0,0,0,0,0,0,0,0,0,0,0,0.2,0.2,0,0.2,0,0,0,0,0,0,0,0.2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.2,0,0,0),
           c(0,0,0,0,0,0,0,0,0,0,0.25,0,0,0,0.25,0,0,0,0,0.25,0,0,0,0,0,0,0,0,0,0,0,0,0.25,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),
           c(0,0,0,0,0,0,0,0,0,0,0.166666666666667,0,0,0,0,0,0,0,0,0,0.166666666666667,0,0.166666666666667,0,0.166666666666667,0,0,0,0,0,0,0,0,0,0,0,0,0,0.166666666666667,0,0,0,0,0,0,0,0.166666666666667,0,0,0),
           c(0,0,0,0,0.25,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.25,0,0.25,0,0,0,0,0,0,0,0,0.25,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),
           c(0,0,0,0,0,0,0,0,0,0,0.142857142857143,0.142857142857143,0,0,0,0,0,0,0,0,0,0,0.142857142857143,0,0,0,0,0,0,0,0,0,0.142857142857143,0,0,0,0,0,0,0.142857142857143,0,0,0,0.142857142857143,0,0.142857142857143,0,0,0,0),
           c(0,0,0.333333333333333,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.333333333333333,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.333333333333333,0,0,0,0,0,0,0,0,0),
           c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),
           c(0,0,0,0,0,0,0.25,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.25,0,0,0,0,0,0,0,0.25,0,0.25,0,0,0,0),
           c(0,0,0,0,0,0.2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.2,0,0,0.2,0,0,0,0,0,0,0.2,0,0,0,0,0,0.2,0,0,0,0,0,0,0),
           c(0,0,0,0,0,0,0,0,0,0,0,0.333333333333333,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.333333333333333,0,0,0,0,0,0,0,0,0,0,0,0,0,0.333333333333333,0,0,0),
           c(0,0,0,0,0,0,0,0,0,0,0,0,0.25,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.25,0,0,0,0,0,0,0.25,0,0,0,0,0,0,0,0.25,0,0,0),
           c(0.2,0,0.2,0,0,0,0,0.2,0,0,0,0,0,0,0,0.2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.2,0,0,0,0,0,0,0,0,0,0),
           c(0,0,0.125,0,0,0,0,0,0,0,0.125,0,0.125,0.125,0.125,0,0,0,0,0,0,0,0,0,0.125,0,0,0,0,0,0,0,0,0.125,0,0,0,0,0,0.125,0,0,0,0,0,0,0,0,0,0),
           c(0,0,0,0,0,0,0,0,0,0.25,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.25,0,0,0,0,0,0,0.25,0,0,0,0,0,0,0,0,0.25,0,0),
           c(0,0,0,0,0.166666666666667,0,0,0,0,0,0,0,0.166666666666667,0.166666666666667,0,0,0,0,0,0,0,0,0.166666666666667,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.166666666666667,0,0,0,0,0,0,0,0,0.166666666666667,0,0),
           c(0,0.2,0,0.2,0,0,0,0,0,0.2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.2,0,0,0,0,0,0,0.2,0,0,0,0,0,0,0,0),
           c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.333333333333333,0,0.333333333333333,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.333333333333333,0,0,0,0,0,0,0),
           c(0,0,0,0,0,0,0.333333333333333,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.333333333333333,0,0,0,0,0,0.333333333333333,0,0,0,0,0,0,0,0,0,0,0,0,0,0),
           c(0,0.25,0,0,0.25,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.25,0,0,0,0,0,0,0.25,0,0,0,0,0,0,0,0,0),
           c(0,0,0,0,0,0.2,0,0,0,0,0,0,0,0,0,0,0,0,0.2,0,0,0,0,0,0,0,0,0.2,0,0,0,0,0,0,0,0.2,0,0,0,0,0,0,0.2,0,0,0,0,0,0,0),
           c(0,0,0,0,0,0,0,0,0.25,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.25,0,0.25,0,0,0,0.25,0,0,0,0,0,0),
           c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.333333333333333,0,0,0.333333333333333,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.333333333333333,0,0,0,0,0,0,0,0,0,0,0),
           c(0,0,0,0,0,0,0,0,0,0,0,0.2,0,0,0.2,0,0,0,0,0.2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.2,0,0,0,0,0,0,0,0,0,0.2,0,0,0,0),
           c(0,0,0.166666666666667,0,0.166666666666667,0,0,0,0,0,0,0,0,0.166666666666667,0,0,0,0,0,0,0,0,0.166666666666667,0,0,0,0,0,0.166666666666667,0,0,0,0,0,0,0,0,0,0,0,0.166666666666667,0,0,0,0,0,0,0,0,0),
           c(0,0,0,0.25,0,0,0,0,0,0.25,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.25,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.25,0,0,0,0,0),
           c(0,0,0,0,0,0,0.166666666666667,0,0,0,0,0,0,0,0,0,0,0.166666666666667,0,0,0,0,0,0,0,0,0,0.166666666666667,0,0.166666666666667,0,0,0.166666666666667,0,0,0,0,0,0,0,0,0,0,0,0,0.166666666666667,0,0,0,0),
           c(0,0,0,0,0,0.5,0,0,0,0,0,0,0,0,0,0,0,0,0.5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),
           c(0,0,0,0,0,0,0,0,0.5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),
           c(0,0,0,0,0,0,0,0,0,0,0,0,0.166666666666667,0,0,0,0,0,0,0,0.166666666666667,0,0,0.166666666666667,0.166666666666667,0,0,0,0,0,0,0.166666666666667,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.166666666666667,0,0),
           c(0.125,0,0.125,0,0,0,0,0,0.125,0,0,0,0,0,0.125,0,0,0,0,0,0,0.125,0.125,0,0,0,0,0,0,0,0.125,0,0,0,0,0,0,0,0,0,0,0,0,0.125,0,0,0,0,0,0),
           c(0,0,0.25,0,0,0,0,0,0,0,0,0,0,0,0,0.25,0,0,0,0,0,0,0,0,0,0,0,0,0.25,0,0,0,0,0.25,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),
           c(0,0.2,0,0,0.2,0,0,0,0,0.2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.2,0,0),
           c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.333333333333333,0,0,0,0,0,0,0,0.333333333333333,0,0,0.333333333333333,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),
           c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.2,0,0,0.2,0,0,0,0,0,0,0,0,0,0,0,0,0.2,0,0,0,0,0,0,0,0,0.2,0,0,0,0,0,0.2,0,0,0,0),
           c(0,0,0,0,0,0,0,0,0,0.5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),
           c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.2,0,0,0.2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.2,0,0,0.2,0,0,0,0,0,0,0,0.2,0,0,0,0,0,0),
           c(0,0,0,0,0,0,0,0,0,0,0.25,0,0.25,0,0,0,0,0,0,0.25,0.25,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),
           c(0,0,0,0,0.166666666666667,0,0,0,0,0.166666666666667,0,0,0,0,0,0,0,0,0,0,0,0,0,0.166666666666667,0.166666666666667,0,0,0,0,0,0,0,0,0,0,0,0,0,0.166666666666667,0,0,0.166666666666667,0,0,0,0,0,0,0,0),
           c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),
           c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0))

t <- 21 ## i manually set this, following FHC.
n <- dim(W)[1]
nt <- n*t
i_t <- diag(t) ## create an identity matrix of size t=21
WNT <- kronecker(i_t, W) ## place a cross-sec W in the diag of the identity matrix as a block
dim(WNT) # 1050*1050
all(WNT[1:10, 1:10]==WNT[51:60, 51:60])

i_nt <- diag(n*t)
dim(i_nt); i_nt[1:10, 1:10]

i_nt1 <- diag(n*(t-1))
dim(i_nt1) # check dimension JIC >> OK.

## let's make 2 awkward part-matrices
top <- matrix(0, n, n*(t-1))
#top <- matrix(0, n, n*t)
dim(top)
right <- matrix(0, nt, n)
dim(right)

## glue them together
TL <- cbind(rbind(top, i_nt1), right)
dim(TL)
TL[1:10, 1:10] # should be all zeroes
TL[51:60, 1:10] # should be 1's on the diagonal

# # add temporal lag to W
# diag(WNT[-(1:n),-((n*t):(n*t))]) <- 1
# WNT[1:10, 1:10] # should bei row standardized weights matrix
# WNT[51:60, 1:10] # should be 1's on the diagonal


# Functions ----------------------------------------------------------------------------------


get_beta <- function(params) {
  as.numeric(params[grepl('beta', x = names(params))])
}


# Simulations ----------------------------------------------------------------------------------

## Parameter tibble
param_tb <- expand.grid(N = c(50),
                        TT = c(21),
                        rho = c(0.1), # c(0.1, 0.25),
                        gamma = c(0.3), # c(0.3, 0.5),
                        beta0 = -1.5,
                        beta1 = 3,
                        seed = c(1:n_repetitions), # Replications per config (number of MCs)
                        method = c('ris'),
                        stringsAsFactors = FALSE) %>%
  as_tibble()

## Prep parallelization
cl <- makeCluster(n_cores)
registerDoParallel(cl)

## Monte Carlos
M <- nrow(param_tb)
results_tb <- foreach (i = 1:M, .packages = c("spmle",
                                              "spatialprobit",
                                              "risprobit",
                                              "spatialreg",
                                              "McSpatial"),
                       .combine = bind_rows) %dopar% {

  params <- param_tb[i,]
  ## Simulates some spatial probit data
  set.seed(params$seed)
  # extract coefficients
  beta <- get_beta(params)
  rho <- params$rho
  gamma <- params$gamma

  # prep data list
  data <- list()
  data$N <- params$N
  data$TT <- params$TT
  # X
  data$X <- cbind(rep(1, 1050), runif(n=1050, min=-1, max=2))
  # y
  data$ystar <- solve(i_nt-rho*WNT-gamma*TL)%*%(data$X%*%beta + rnorm(n=1050,mean = 0, sd=1))
  data$y <- ifelse(data$ystar>0, 1, 0)
  # W
  data$W_t <- as.matrix(WNT, sparse=TRUE)

  ## Estimate
  err <- tryCatch(
    expr = {
  ris <- RisSpatialProbit$new(X = data$X,
                              y = data$y,
                              W_t = data$W_t,
                              N = data$N, TT = data$TT,
                              temporal_dep = has_temporal_lag,
                              spatial_dep = has_spatial_lag)
    perf <- system.time({
      ris$train()
    })

    # extract values
    elapsed <- perf[3]
    gamma <- ris$gamma
    rho <- ris$rho
    beta <- ris$beta
    ses <- sqrt(diag(ris$VC_mat))
    },
  error = function(e) {
    return(e)
    }
  )

  K <- ncol(data$X)

  # Deal with error
  if (inherits(err, 'error')) {
    elapsed <- NA
    rho <- NA
    gamma <- NA
    beta <- rep(NA, K)
    ses <- rep(NA, K+2)
  }

  # Prep return value
  beta_names <- paste('beta', 0:(K-1), rep(c("_hat", "_se"), each=2), sep = "")
  res_names <- c('time', beta_names, 'gamma_hat', 'gamma_se', 'rho_hat', "rho_se")
  res_ls <- as.list(c(elapsed, beta, ses[1:2], gamma, ses[3], rho, ses[4]))
  names(res_ls) <- res_names

  c(params, res_ls)
}
stopCluster(cl)

  ## Process / save results
if (save_results) {
  save(results_tb, file=save_path, version=3)
}


